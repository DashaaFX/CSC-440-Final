{% extends "base.html" %}
{% block title %}Ticket #{{ ticket.ticket_id }}{% endblock %}
{% block content %}
<div class="ticket-detail-balanced">
  <div class="meta-col">
    <section class="card">
      <div class="card-header" style="margin-bottom:10px;">
        <h2 style="font-size:1.05rem;">Ticket #{{ ticket.ticket_id }}</h2>
        <div class="actions">
          <!-- Back button based on user role -->
          {% if current_user.is_authenticated %}
            {% if current_user.role.value == 'requester' %}
              <a class="btn-outline" href="{{ url_for('dashboard.requester_dashboard') }}">Back</a>
            {% elif current_user.role.value == 'technician' %}
              <a class="btn-outline" href="{{ url_for('dashboard.technician_dashboard') }}">Back</a>
            {% elif current_user.role.value == 'manager' %}
              <a class="btn-outline" href="{{ url_for('dashboard.manager_dashboard') }}">Back</a>
            {% else %}
              <a class="btn-outline" href="{{ url_for('index') }}">Back</a>
            {% endif %}
          {% else %}
            <a class="btn-outline" href="{{ url_for('index') }}">Back</a>
          {% endif %}
        </div>
      </div>
      <div style="display:grid; gap:10px; font-size:.85rem;">
        <div><strong>Title:</strong> {{ ticket.title }}</div>
        <div><strong>Category:</strong> {{ ticket.category.category_name if ticket.category else '—' }}</div>
        <div><strong>Status:</strong> <span
            class="badge badge-{{ ticket.status.status_name|lower|replace(' ', '-') }}">{{ ticket.status.status_name if
            ticket.status else '—' }}</span></div>
        <div><strong>Location:</strong> {{ ticket.location }}</div>
        <div><strong>Requester:</strong> {{ ticket.requester.first_name }} {{ ticket.requester.last_name }}</div>
        <div><strong>Technician:</strong> {{ ticket.technician.first_name ~ ' ' ~ ticket.technician.last_name if
          ticket.technician else 'Unassigned' }}</div>
        <div><strong>Created:</strong> {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
      </div>
      <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;" />
      {% if rating %}
      <p style="margin:0 0 10px; font-size:.85rem;">Rating: {{ rating.rating_value }}/5{% if rating.feedback %} — {{
        rating.feedback }}{% endif %}</p>
      {% endif %}
      {% if ticket.status and ticket.status.status_name == 'Resolved' and ticket.requester_id == current_user.user_id %}
      <form method="post" action="{{ url_for('ratings.add_rating') }}" class="form" style="margin-top:8px;">
        <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
        <div class="form-row">
          <label for="ratingValue">Rating (1-5)</label>
          <select id="ratingValue" name="rating_value" class="select" required>
            {% for i in range(1,6) %}
            <option value="{{ i }}" {% if rating and rating.rating_value==i %}selected{% endif %}>{{ i }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-row">
          <label for="feedbackField">Feedback (optional)</label>
          <textarea id="feedbackField" name="feedback" class="textarea"
            style="min-height:80px;">{{ rating.feedback if rating else '' }}</textarea>
        </div>
        <div class="form-actions">
          <button class="btn" type="submit">Submit</button>
        </div>
      </form>
      {% else %}
      <p style="color:var(--muted); margin:0; font-size:.75rem;">Requester can rate after resolution.</p>
      {% endif %}
    </section>
  </div>

  <div class="content-col">
    <section class="card">
      <div class="card-header">
        <h3 style="margin:0; font-size:1rem;">Description</h3>
      </div>
      <p style="margin:0; line-height:1.5;">{{ ticket.description }}</p>
    </section>
    <section class="card">
      <div class="card-header">
        <h3 style="margin:0; font-size:1rem;">Comments</h3>
      </div>
      <form method="post" action="{{ url_for('comments.add_comment') }}" class="form" style="margin-bottom:12px;">
        <input type="hidden" name="ticket_id" value="{{ ticket.ticket_id }}">
        <div class="form-row">
          <label for="commentText">Add a comment</label>
          <textarea id="commentText" name="comment_text" class="textarea" required style="min-height:100px;"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn" type="submit">Post</button>
        </div>
      </form>
      {% if comments %}
      <ul class="alerts comments-scroll">
        {% for c in comments %}
        <li class="alert" style="font-size:.8rem;">
          <strong>{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</strong>
          — {{ c.user_id == ticket.requester_id and 'Requester' or (c.user_id == (ticket.technician_id or -1) and
          'Technician' or 'User #' ~ c.user_id) }}
          <div style="margin-top:4px; line-height:1.4;">{{ c.comment_text }}</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p style="color:var(--muted); margin:0;">No comments yet.</p>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}